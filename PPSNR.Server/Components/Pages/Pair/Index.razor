@page "/pairs"
@attribute [Microsoft.AspNetCore.Mvc.IgnoreAntiforgeryToken]
@using PPSNR.Server.Data.Entities
@using System.Security.Claims
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider Auth
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@rendermode InteractiveServer

<h1>Streamer Pairs</h1>

<div class="mb-3">
    <button @onclick="CreateSamplePair" disabled="@_busy" class="btn btn-primary">@(_busy ? "Creating..." : "Create Sample Pair")</button>
    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <div class="@(_statusIsError ? "alert alert-danger" : "alert alert-success") mt-2">
            @_status
        </div>
    }
    <button class="btn btn-secondary ms-2" @onclick="Reload" disabled="@_busy">Reload</button>
    <span class="ms-2 text-muted">Total: @_allPairs.Count | Filtered: @_filteredPairs.Count</span>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h5>Filters</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Pair Name</label>
                <input type="text"
                       class="form-control"
                       placeholder="Search pair name..."
                       value="@_filterPairName"
                       @oninput="(ChangeEventArgs e) => OnFilterChanged(() => _filterPairName = e.Value?.ToString() ?? string.Empty)" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Owner Name</label>
                <input type="text"
                       class="form-control"
                       placeholder="Search owner..."
                       value="@_filterOwnerName"
                       @oninput="(ChangeEventArgs e) => OnFilterChanged(() => _filterOwnerName = e.Value?.ToString() ?? string.Empty)" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Partner Name</label>
                <input type="text"
                       class="form-control"
                       placeholder="Search partner..."
                       value="@_filterPartnerName"
                       @oninput="(ChangeEventArgs e) => OnFilterChanged(() => _filterPartnerName = e.Value?.ToString() ?? string.Empty)" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Your Role</label>
                <select class="form-control"
                        value="@_filterRole"
                        @onchange="(ChangeEventArgs e) => OnFilterChanged(() => _filterRole = e.Value?.ToString() ?? string.Empty)">
                    <option value="">All Roles</option>
                    <option value="owner">Owner</option>
                    <option value="partner">Partner</option>
                    <option value="both">Owner & Partner</option>
                </select>
            </div>
        </div>
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">Clear Filters</button>
        </div>
    </div>
</div>

@if (_filteredPairs.Count == 0)
{
    <div class="alert alert-info">
        @if (_allPairs.Count == 0)
        {
            <p>No pairs found. <button class="btn btn-sm btn-primary" @onclick="CreateSamplePair" disabled="@_busy">Create your first pair</button></p>
        }
        else
        {
            <p>No pairs match the current filters.</p>
        }
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Pair Name</th>
                    <th>Owner</th>
                    <th>Partner</th>
                    <th>Your Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in _filteredPairs)
                {
                    var userRole = GetUserRole(p);
                    <tr>
                        <td>
                            <strong>@p.Name</strong>
                        </td>
                        <td>@(p.Owner?.UserName ?? "Unassigned")</td>
                        <td>@(p.Partner?.UserName ?? "Unassigned")</td>
                        <td>
                            <span class="badge bg-info">@userRole</span>
                        </td>
                        <td>
                            <a href="/pairs/@p.Id" class="btn btn-sm btn-primary">View Details</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<StreamerPair> _allPairs = new();
    private List<StreamerPair> _filteredPairs = new();
    private bool _busy;
    private string? _status;
    private bool _statusIsError;
    private string? _userId;
    private string _filterPairName = string.Empty;
    private string _filterOwnerName = string.Empty;
    private string _filterPartnerName = string.Empty;
    private string _filterRole = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Reload();
    }

    private async Task Reload()
    {
        try
        {
            _busy = true;
            await using var db = await DbFactory.CreateDbContextAsync();

            // Determine current user
            var state = await Auth.GetAuthenticationStateAsync();
            _userId = state.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(_userId))
            {
                _allPairs = new List<StreamerPair>();
                _filteredPairs = new List<StreamerPair>();
                return;
            }

            // Load all pairs where the current user participates (owner or partner)
            _allPairs = await db.Pairs
                .AsNoTracking()
                .Include(p => p.Owner)
                .Include(p => p.Partner)
                .Where(p => p.OwnerUserId == _userId || p.PartnerUserId == _userId)
                .OrderByDescending(p => p.CreatedAt)
                .ToListAsync();

            ApplyFilters();
        }
        finally
        {
            _busy = false;
        }
    }

    private void OnFilterChanged(Action updateFilter)
    {
        updateFilter();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        _filteredPairs = _allPairs
            .Where(p =>
            {
                // Filter by pair name
                if (!string.IsNullOrWhiteSpace(_filterPairName) &&
                    !p.Name.Contains(_filterPairName, StringComparison.OrdinalIgnoreCase))
                {
                    return false;
                }

                // Filter by owner name
                if (!string.IsNullOrWhiteSpace(_filterOwnerName) &&
                    !p.Owner?.UserName?.Contains(_filterOwnerName, StringComparison.OrdinalIgnoreCase) == true)
                {
                    return false;
                }

                // Filter by partner name
                if (!string.IsNullOrWhiteSpace(_filterPartnerName))
                {
                    var partnerMatches = p.Partner?.UserName?.Contains(_filterPartnerName, StringComparison.OrdinalIgnoreCase) == true;
                    if (!partnerMatches)
                    {
                        return false;
                    }
                }

                // Filter by user role
                if (!string.IsNullOrWhiteSpace(_filterRole))
                {
                    var isOwner = string.Equals(p.OwnerUserId, _userId, StringComparison.Ordinal);
                    var isPartner = string.Equals(p.PartnerUserId, _userId, StringComparison.Ordinal);

                    switch (_filterRole)
                    {
                        case "owner" when !isOwner:
                        case "partner" when !isPartner:
                        case "both" when !(isOwner && isPartner):
                            return false;
                    }
                }

                return true;
            })
            .ToList();
    }

    private void ClearFilters()
    {
        _filterPairName = string.Empty;
        _filterOwnerName = string.Empty;
        _filterPartnerName = string.Empty;
        _filterRole = string.Empty;
        ApplyFilters();
    }

    private string GetUserRole(StreamerPair pair)
    {
        var isOwner = string.Equals(pair.OwnerUserId, _userId, StringComparison.Ordinal);
        var isPartner = string.Equals(pair.PartnerUserId, _userId, StringComparison.Ordinal);

        if (isOwner && isPartner) return "Owner & Partner";
        if (isOwner) return "Owner";
        if (isPartner) return "Partner";
        return "Viewer";
    }

    private async Task CreateSamplePair()
    {
        _status = null;
        _statusIsError = false;
        _busy = true;
        StateHasChanged();
        try
        {
            var dtoText = await JS.InvokeAsync<string>("ppsnr.postWithAntiforgery", "api/admin/pairs");
            var json = System.Text.Json.JsonDocument.Parse(dtoText);
            var pairId = json.RootElement.GetProperty("id").GetGuid();
            _status = $"Created pair '{pairId}'";
            await Reload();
        }
        catch (Exception ex)
        {
            _statusIsError = true;
            _status = $"Error: {ex.GetType().Name} - {ex.Message}";
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }
}
