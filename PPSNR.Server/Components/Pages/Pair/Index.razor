@page "/pairs"
@attribute [Microsoft.AspNetCore.Mvc.IgnoreAntiforgeryToken]
@using PPSNR.Server.Data.Entities
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@rendermode InteractiveServer

<h1>Streamer Pairs</h1>

<div style="margin-bottom:8px;">
    <button @onclick="CreateSamplePair" disabled="@_busy">@(_busy ? "Creating..." : "Create Sample Pair")</button>
    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <span style="margin-left:10px; color:@(_statusIsError ? "#c00" : "#090")">@_status</span>
    }
    <button style="margin-left:10px;" @onclick=Reload disabled="@_busy">Reload</button>
    <span style="margin-left:10px; color:#666">Count: @_pairs.Count</span>
    @if (_lastCreatedId != Guid.Empty)
    {
        <span style="margin-left:10px; color:#666">Last created: @_lastCreatedId</span>
    }
</div>

<ul>
    @foreach (var p in _pairs)
    {
        <li>
            <b>@p.Name</b>
            @if (_links.TryGetValue(p.Id, out var link))
            {
                <div>
                    View: <a href="/@p.Id/view/@link.ViewToken" target="_blank">/@p.Id/view/@link.ViewToken</a>
                </div>
                <div>
                    Edit: <a href="/@p.Id/edit/@link.EditToken" target="_blank">/@p.Id/edit/@link.EditToken</a>
                </div>
            }
            else
            {
                <button @onclick="(() => GenerateLinks(p.Id))">Generate Links</button>
            }
        </li>
    }
</ul>

@code {
    private List<StreamerPair> _pairs = new();
    private Dictionary<Guid, PairLink> _links = new();
    private bool _busy;
    private string? _status;
    private bool _statusIsError;
    private Guid _lastCreatedId;

    protected override async Task OnInitializedAsync()
    {
        await Reload();
    }

    private async Task Reload()
    {
        try
        {
            _busy = true;
            await using var db = await DbFactory.CreateDbContextAsync();
            _pairs = await db.Pairs.AsNoTracking().OrderByDescending(p => p.CreatedAt).ToListAsync();
            _links.Clear();
            var pairIds = _pairs.Select(p => p.Id).ToList();
            var existingLinks = await db.PairLinks.AsNoTracking().Where(l => pairIds.Contains(l.PairId)).ToListAsync();
            foreach (var l in existingLinks)
            {
                _links[l.PairId] = l;
            }
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task GenerateLinks(Guid id)
    {
        // Perform the POST from the browser so antiforgery cookie and header are included
        // The JS helper will fetch an antiforgery token/cookie pair and then POST with the header
        var dtoText = await JS.InvokeAsync<string>("ppsnr.postWithAntiforgery", $"api/pairs/{id}/links");
        var dto = System.Text.Json.JsonDocument.Parse(dtoText);
        var viewToken = dto.RootElement.GetProperty("viewToken").GetGuid();
        var editToken = dto.RootElement.GetProperty("editToken").GetGuid();
        _links[id] = new PairLink { PairId = id, ViewToken = viewToken, EditToken = editToken };
        StateHasChanged();
    }

    private async Task CreateSamplePair()
    {
        _status = null;
        _statusIsError = false;
        _busy = true;
        StateHasChanged();
        try
        {
            // Authenticated creation via API so that antiforgery and authorization are enforced
            var dtoText = await JS.InvokeAsync<string>("ppsnr.postWithAntiforgery", "api/admin/pairs");
            var json = System.Text.Json.JsonDocument.Parse(dtoText);
            _lastCreatedId = json.RootElement.GetProperty("id").GetGuid();
            _status = $"Created pair '{_lastCreatedId}'";
            await Reload();
        }
        catch (Exception ex)
        {
            _statusIsError = true;
            _status = $"Error: {ex.GetType().Name} - {ex.Message}";
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }
}
