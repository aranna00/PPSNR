@page "/{pairId:guid}/edit/{token:guid}"
@using PPSNR.Server2.Data.Entities
@attribute [Authorize]
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS

<style>
    html, body, #app { background: transparent; margin: 0; padding: 0; }
    #canvas { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
    .drag { position: absolute; touch-action: none; cursor: move; }
    .hud { position: fixed; top: 8px; left: 8px; background: rgba(0,0,0,0.5); color: white; padding: 6px 10px; border-radius: 6px; font-family: sans-serif; }
</style>

@if (!authorized)
{
    <div class="hud">Forbidden. Invalid token.</div>
}
else if (layouts is null)
{
    <div class="hud">Loading...</div>
}
else
{
    <div class="hud">
        <b>@pair?.Name</b> — Drag images to reposition. Changes auto-save.
    </div>
    <div id="canvas" data-pair-id="@pairId">
        @foreach (var l in layouts)
        {
            @foreach (var s in slots.Where(s => s.LayoutId == l.Id))
            {
                <img class="drag" data-slot-id="@s.Id" data-layout-id="@l.Id" src="@s.ImageUrl" style="left:@(s.X)px; top:@(s.Y)px; z-index:@s.ZIndex; display:@(s.Visible ? "block" : "none");" />
            }
        }
    </div>
}

@code {
    [Parameter] public Guid pairId { get; set; }
    [Parameter] public Guid token { get; set; }

    private bool authorized;
    private StreamerPair? pair;
    private List<Layout>? layouts;
    private List<Slot> slots = new();
    private HubConnection? hub;

    protected override async Task OnInitializedAsync()
    {
        // Validate edit token
        var link = Db.PairLinks.FirstOrDefault(l => l.PairId == pairId);
        authorized = link != null && link.EditToken == token && (link.ExpiresAt == null || link.ExpiresAt > DateTime.UtcNow);
        if (!authorized) return;

        pair = Db.Pairs.FirstOrDefault(p => p.Id == pairId);
        layouts = Db.Layouts.Where(l => l.PairId == pairId).ToList();
        var layoutIds = layouts.Select(l => l.Id).ToList();
        slots = Db.Slots.Where(s => layoutIds.Contains(s.LayoutId)).OrderBy(s => s.ZIndex).ToList();

        // SignalR to see live updates from other editors
        hub = new HubConnectionBuilder().WithUrl(Nav.ToAbsoluteUri("/hubs/layout")).WithAutomaticReconnect().Build();
        hub.On<object>("SlotUpdated", payload =>
        {
            var json = System.Text.Json.JsonDocument.Parse(System.Text.Json.JsonSerializer.Serialize(payload));
            var id = json.RootElement.GetProperty("Id").GetGuid();
            var slot = slots.FirstOrDefault(s => s.Id == id);
            if (slot != null)
            {
                slot.X = (float)json.RootElement.GetProperty("X").GetDouble();
                slot.Y = (float)json.RootElement.GetProperty("Y").GetDouble();
                slot.ZIndex = json.RootElement.GetProperty("ZIndex").GetInt32();
                slot.Visible = json.RootElement.GetProperty("Visible").GetBoolean();
                InvokeAsync(StateHasChanged);
            }
        });
        await hub.StartAsync();
        await hub.SendAsync("SubscribeToPair", pairId.ToString());
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && authorized)
        {
            await JS.InvokeVoidAsync("PPSNR_Drag.init", "/api", pairId.ToString());
        }
    }
}
