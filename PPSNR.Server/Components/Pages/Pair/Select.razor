@page "/{pairId:guid}/select/{token:guid}"
@using PPSNR.Server.Components.Pokemon
@using PPSNR.Server.Data.Entities
@attribute [Authorize]
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@inject IJSRuntime JS
@inject Services.LayoutService LayoutSvc
@rendermode InteractiveServer

<div class="container-fluid py-4">
    @if (!_authorized)
    {
        <div class="alert alert-danger">Forbidden. Invalid token or you don't have access.</div>
    }
    else if (_pair == null)
    {
        <div class="alert alert-info">Loading...</div>
    }
    else
    {
        <h2>@_pair.Name - Pokemon & Badge Selection</h2>
        <p class="text-muted">Profile: <strong>@(_isOwner ? "Owner" : "Partner")</strong></p>

        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            <div class="alert @(_statusIsError ? "alert-danger" : "alert-success")">@_statusMessage</div>
        }

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <button class="nav-link @(_activeTab == "pokemon" ? "active" : "")" @onclick='@(() => _activeTab = "pokemon")'>
                    Pokemon Slots
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(_activeTab == "badges" ? "active" : "")" @onclick='@(() => _activeTab = "badges")'>
                    Badge Slots
                </button>
            </li>
        </ul>

        @if (_activeTab == "pokemon")
        {
            <h3>Pokemon Slots</h3>
            <div class="row">
                @foreach (var slot in _pokemonSlots)
                {
                    <PokemonChooser
                        Slot="slot"
                        CurrentImageUrl="@slot.ImageUrl"
                        Visible="@GetVisible(slot)"
                        Profile="@(slot.Profile)"
                        OnVisibleChanged="@(v => _ = UpdateSlotVisibility(slot, v))"
                        OnSetImageUrl="@(url => UpdateSlotImage(slot, url))" />
                }
            </div>
        }
        else if (_activeTab == "badges")
        {
            <h3>Badge Slots</h3>
            <div class="row">
                @foreach (var slot in _badgeSlots)
                {
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Badge @slot.Index</h5>
                                @if (!string.IsNullOrEmpty(slot.ImageUrl))
                                {
                                    <img src="@slot.ImageUrl" alt="Badge" class="img-fluid mb-2" style="max-height: 100px;" />
                                }
                                <input type="text" class="form-control mb-2" placeholder="Image URL" value="@slot.ImageUrl" @onchange="e => UpdateSlotImage(slot, e.Value?.ToString())" />
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="visible-@slot.Id" checked="@GetVisible(slot)" @onchange="e => UpdateSlotVisibility(slot, (bool)(e.Value ?? false))" />
                                    <label class="form-check-label" for="visible-@slot.Id">Visible</label>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public Guid PairId { get; set; }
    [Parameter] public Guid Token { get; set; }

    private bool _authorized;
    private bool _isOwner;
    private StreamerPair? _pair;
    private List<Slot> _pokemonSlots = [];
    private List<Slot> _badgeSlots = [];
    private Dictionary<Guid, SlotPlacement> _placements = new();
    private string _activeTab = "pokemon";
    private string? _statusMessage;
    private bool _statusIsError;
    private HubConnection? _hub;

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
    }

    protected override async Task OnInitializedAsync()
    {
        // Validate token: accept either EditToken (owner) or PartnerEditToken (partner)
        var link = Db.PairLinks.FirstOrDefault(l => l.PairId == PairId);
        if (link != null && (link.ExpiresAt == null || link.ExpiresAt > DateTime.UtcNow))
        {
            if (link.EditToken == Token)
            {
                _isOwner = true;
                // Verify owner
                var state = await Auth.GetAuthenticationStateAsync();
                var userId = state.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                _pair = Db.Pairs.FirstOrDefault(p => p.Id == PairId);
                _authorized = _pair != null && !string.IsNullOrEmpty(userId) && string.Equals(_pair.OwnerUserId, userId, StringComparison.Ordinal);
            }
            else if (link.PartnerEditToken == Token)
            {
                _isOwner = false;
                _authorized = true;
                _pair = Db.Pairs.FirstOrDefault(p => p.Id == PairId);
            }
        }

        if (!_authorized) return;

        var profile = _isOwner ? SlotProfile.Owner : SlotProfile.Partner;
        var layouts = Db.Layouts.Where(l => l.PairId == PairId).ToList();
        var layoutIds = layouts.Select(l => l.Id).ToList();
        var allSlots = Db.Slots.Where(s => layoutIds.Contains(s.LayoutId)).OrderBy(s => s.Index).ToList();

        // Load placements for current profile
        _placements = Db.SlotPlacements
            .Where(p => allSlots.Select(s => s.Id).Contains(p.SlotId) && p.Profile == profile)
            .ToDictionary(p => p.SlotId, p => p);

        _pokemonSlots = allSlots.Where(s => s.SlotType == SlotType.Pokemon).ToList();
        _badgeSlots = allSlots.Where(s => s.SlotType == SlotType.Badge).ToList();

        // SignalR for live updates
        _hub = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/hubs/layout"))
            .WithAutomaticReconnect(new Shared.SignalR.AdvancedRetryPolicy())
            .Build();
        _hub.On<object>("SlotUpdated", payload =>
        {
            try
            {
                Guid id;
                string? imageUrl = null;
                int? profile = null;
                bool? visible = null;
                float? x = null;
                float? y = null;
                int? z = null;

                bool TryProp(System.Text.Json.JsonElement el, string name, out System.Text.Json.JsonElement prop)
                {
                    if (el.TryGetProperty(name, out prop)) return true;
                    var camel = string.IsNullOrEmpty(name) ? name : char.ToLowerInvariant(name[0]) + name.Substring(1);
                    return el.TryGetProperty(camel, out prop);
                }

                bool TryVal(IDictionary<string, object> dict, string name, out object? value)
                {
                    if (dict.TryGetValue(name, out value)) return true;
                    var camel = string.IsNullOrEmpty(name) ? name : char.ToLowerInvariant(name[0]) + name.Substring(1);
                    return dict.TryGetValue(camel, out value);
                }

                // Handle payload when it comes as JsonElement
                if (payload is System.Text.Json.JsonElement el)
                {
                    if (!TryProp(el, "Id", out var idProp)) return; // unknown payload, ignore
                    id = idProp.GetGuid();
                    if (TryProp(el, "ImageUrl", out var imgProp)) imageUrl = imgProp.ValueKind == System.Text.Json.JsonValueKind.Null ? null : imgProp.GetString();
                    if (TryProp(el, "Profile", out var pr)) profile = pr.GetInt32();
                    if (TryProp(el, "Visible", out var vProp)) visible = vProp.GetBoolean();
                    if (TryProp(el, "X", out var xProp)) x = (float)xProp.GetDouble();
                    if (TryProp(el, "Y", out var yProp)) y = (float)yProp.GetDouble();
                    if (TryProp(el, "ZIndex", out var zProp)) z = zProp.GetInt32();
                }
                // Handle payload when it comes as a dictionary (e.g., from JS/SignalR variations)
                else if (payload is IDictionary<string, object> dict)
                {
                    if (!TryVal(dict, "Id", out var idObj) || idObj is null || !Guid.TryParse(idObj.ToString(), out id)) return;
                    if (TryVal(dict, "ImageUrl", out var imgObj)) imageUrl = imgObj == null ? null : imgObj.ToString();
                    if (TryVal(dict, "Profile", out var pObj) && int.TryParse(pObj?.ToString(), out var pv)) profile = pv;
                    if (TryVal(dict, "Visible", out var vObj) && bool.TryParse(vObj?.ToString(), out var vv)) visible = vv;
                    if (TryVal(dict, "X", out var xObj) && float.TryParse(xObj?.ToString(), out var xv)) x = xv;
                    if (TryVal(dict, "Y", out var yObj) && float.TryParse(yObj?.ToString(), out var yv)) y = yv;
                    if (TryVal(dict, "ZIndex", out var zObj) && int.TryParse(zObj?.ToString(), out var zv)) z = zv;
                }
                else
                {
                    // Fallback: try serialize-deserialize to JSON as last resort
                    var json = System.Text.Json.JsonDocument.Parse(System.Text.Json.JsonSerializer.Serialize(payload));
                    if (!TryProp(json.RootElement, "Id", out var idProp)) return;
                    id = idProp.GetGuid();
                    if (TryProp(json.RootElement, "ImageUrl", out var imgProp)) imageUrl = imgProp.ValueKind == System.Text.Json.JsonValueKind.Null ? null : imgProp.GetString();
                    if (TryProp(json.RootElement, "Profile", out var pr)) profile = pr.GetInt32();
                    if (TryProp(json.RootElement, "Visible", out var vProp)) visible = vProp.GetBoolean();
                    if (TryProp(json.RootElement, "X", out var xProp)) x = (float)xProp.GetDouble();
                    if (TryProp(json.RootElement, "Y", out var yProp)) y = (float)yProp.GetDouble();
                    if (TryProp(json.RootElement, "ZIndex", out var zProp)) z = zProp.GetInt32();
                }

                var slot = allSlots.FirstOrDefault(s => s.Id == id);
                if (slot != null)
                {
                    if (imageUrl != null)
                    {
                        slot.ImageUrl = imageUrl;
                    }
                    // Only update placement visibility/coords when the profile matches current user context
                    var currentProfile = _isOwner ? SlotProfile.Owner : SlotProfile.Partner;
                    if (profile != null && (int)currentProfile == profile)
                    {
                        if (_placements.TryGetValue(slot.Id, out var placement))
                        {
                            if (visible != null) placement.Visible = visible.Value;
                            if (x != null) placement.X = x.Value;
                            if (y != null) placement.Y = y.Value;
                            if (z != null) placement.ZIndex = z.Value;
                        }
                    }
                    InvokeAsync(StateHasChanged);
                }
            }
            catch
            {
                // Swallow malformed payloads; they may target other pages/profiles.
            }
        });
        // Typed envelope handler for forward-compatible messages
        _hub.On<PPSNR.Shared.SignalR.SignalRMessageEnvelope>("Message", envelope =>
        {
            try
            {
                if (envelope == null) return;
                if (string.Equals(envelope.Type, "SlotUpdated", StringComparison.OrdinalIgnoreCase) && envelope.Data.HasValue)
                {
                    var dto = System.Text.Json.JsonSerializer.Deserialize<PPSNR.Shared.SignalR.SlotUpdatedDto>(envelope.Data.Value.GetRawText());
                    if (dto == null) return;

                    var id = dto.Id;
                    var profile = dto.Profile;
                    var imageUrl = dto.ImageUrl;
                    var x = dto.X;
                    var y = dto.Y;
                    var z = dto.ZIndex;
                    var visible = dto.Visible;

                    var slot = allSlots.FirstOrDefault(s => s.Id == id);
                    if (slot != null)
                    {
                        if (imageUrl != null) slot.ImageUrl = imageUrl;
                        if (profile != null && (int)profile == (int)(_isOwner ? SlotProfile.Owner : SlotProfile.Partner))
                        {
                            if (_placements.TryGetValue(slot.Id, out var placement))
                            {
                                if (visible.HasValue) placement.Visible = visible.Value;
                                if (x.HasValue) placement.X = x.Value;
                                if (y.HasValue) placement.Y = y.Value;
                                if (z.HasValue) placement.ZIndex = z.Value;
                            }
                        }
                        InvokeAsync(StateHasChanged);
                    }
                }
            }
            catch
            {
                // ignore malformed envelope
            }
        });
        await _hub.StartAsync();
        await _hub.SendAsync("SubscribeToPair", PairId.ToString());
    }

    private async Task UpdateSlotImage(Slot slot, string? imageUrl)
    {
        try
        {
            // Update shared image on the slot record
            slot.ImageUrl = imageUrl;
            await LayoutSvc.UpdateSlotAsync(PairId, slot);

            _statusMessage = "Updated successfully";
            _statusIsError = false;
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error: {ex.Message}";
            _statusIsError = true;
        }
        StateHasChanged();
    }

    private async Task UpdateSlotVisibility(Slot slot, bool visible)
    {
        try
        {
            // Update visibility via placement for current profile
            slot.Profile = _isOwner ? SlotProfile.Owner : SlotProfile.Partner;
            slot.Visible = visible;
            await LayoutSvc.UpdateSlotAsync(PairId, slot);
            if (_placements.TryGetValue(slot.Id, out var placement))
            {
                placement.Visible = visible;
            }

            _statusMessage = "Updated successfully";
            _statusIsError = false;
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error: {ex.Message}";
            _statusIsError = true;
        }
        StateHasChanged();
    }

    public void Dispose()
    {
        _hub?.DisposeAsync();
    }

    private bool GetVisible(Slot s)
    {
        if (_placements.TryGetValue(s.Id, out var p)) return p.Visible;
        return s.Visible;
    }
}
