version: '3.8'

services:
  ppsnr-server:
    image: my-registry/ppsnr:latest
    build:
      context: .
      dockerfile: PPSNR.Server/Dockerfile
      args:
        APP_UID: "1000"
        BUILD_CONFIGURATION: "Release"
    # Load variables from a local .env file as the primary source for secrets/credentials
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${Kestrel__Password:-}
      # Provide TWITCH values via .env (or the host env); no Docker secrets required
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID:-}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET:-}
      # Connection string: prefer env var (from .env)
      - ConnectionStrings__DefaultConnection=${ConnectionStrings__DefaultConnection:-}
      - DisableHttpsRedirection=${DisableHttpsRedirection:-true}
    ports:
      - "8080:8080"
    volumes:
      # Persist SQLite DB and runtime-generated files under /data
      - ppsnr-data:/data
      - ./PPSNR.Server/appsettings.Production.json:/app/appsettings.Production.json:ro
    # Note: Docker secrets (Swarm) removed. Use .env or host env vars instead.
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 5s
      retries: 3


volumes:
  ppsnr-data:
    driver: local
