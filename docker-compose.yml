services:
  ppsnr-server:
    image: my-registry/ppsnr:latest
    build:
      context: .
      dockerfile: PPSNR.Server/Dockerfile
      args:
        APP_UID: "1000"
        BUILD_CONFIGURATION: "Release"
    # Load variables from a local .env file as the primary source for secrets/credentials
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${Kestrel__Password:-}
      # Provide TWITCH values via .env (or the host env); no Docker secrets required
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID:-}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET:-}
      # Connection string to Postgres (override in .env for secrets)
      - ConnectionStrings__DefaultConnection=${ConnectionStrings__DefaultConnection:-Host=postgres;Port=5432;Database=ppsnr;Username=ppsnr;Password=ppsnr}
      - DisableHttpsRedirection=${DisableHttpsRedirection:-true}
    ports:
      - "8080"
    volumes:
      # Optional: a writable directory if the app generates files (not used for database anymore)
      - ppsnr-data:/data
      - ./PPSNR.Server/appsettings.Production.json:/app/appsettings.Production.json:ro
    # Note: Docker secrets (Swarm) removed. Use .env or host env vars instead.
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 5s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=ppsnr
      - POSTGRES_USER=ppsnr
      - POSTGRES_PASSWORD=ppsnr
    ports:
      - "5432"
    volumes:
      - ppsnr-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ppsnr"]
      interval: 5s
      timeout: 5s
      retries: 5


volumes:
  ppsnr-data:
    driver: local
  ppsnr-pgdata:
    driver: local
